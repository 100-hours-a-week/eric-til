## WebSocket

- 소켓 : 네트워크 상의 두 시스템 간의 통신을 위한 엔드 포인트
    - 엔드 포인트 : 진입점, 시작점, 연결점
- 정의 : 실시간 양방향 통신을 위해 지속적인 연결을 제공하는 프로토콜
- HTTP와는 다른 실시간으로 데이터를 주고 받을 수 있음.
    - HTTP는 클라이언트가 요청을 보내야 응답을 할 수 있음. 편지 같은 느낌
    - 웹 소켓은 전화같은 느낌. 연결 유지되는 동안은 실시간으로 서로 보낼 수 있음
- 사용 이유
    - 실시간 데이터 전송 : 연결 활성화 상태에서는 서버와 클라이언트 간에 실시간으로 데이터 송수신 가능
    - 연결 유지 비용 절감 : HTTP는 요청마다 새로운 연결해야하지만 웹소켓은 한 번 연결하면 지속적 교환
    - 양방향 통신 : 클라이언트와 서버가 동시에 데이터 보낼 수 있음. 요청, 응답 기다리지 않아도 됨
    - 메시지 경계 존중 : 메세지의 시작과 끝을 명확하게 표현되는 프레임 기반 프로토콜
- 사용 방법
    1. 서버와 클라이언트 간의 WebSocket 연결 설정
        - 클라이언트는 웹소켓 URL을 통해 서버에 연결 요청 보냄
        - ws://sdfsadf.com:8000 or wss://sadfasdf.com:80000
    2. 서버에서의 연결 수락
    
    3. 데이터의 송수신
        - 연결이 설정되면 양방향으로 주고받을 수 있음
        - 프레임 단위로 전송
    4. 연결 종료
        - close 프레임을 보내서 연결 종료 과정 진행함
        
        ![image.png](attachment:fd5b291c-c65a-471a-b500-2fed19b7d207:image.png)
        

---

## ws와 wss의 차이점

- ws
    - 기본적인 웹소켓 프로토콜 사용
    - 암호화되지 않은 평문

- wss
    - TlS/SSL을 적용한 보안 웹소켓 프로토콜
    - 모든 데이터 암호화
    - 웹사이트가 HTTPS를 사용할 경우, 웹소켓 연결도 wss를 사용해야 브라우저에서 차단되지 않음

---

## 메시지 프레임과 경계

- 메시지 프레임
    - 웹소켓은 데이터를 프레임 단위로 전송.
    - 프레임 구조
    
    | 필드 | 크기 | 설명 |
    | --- | --- | --- |
    | **FIN** | 1비트 | 메시지의 마지막 프레임 여부 (1이면 마지막 프레임) |
    | **RSV1-3** | 3비트 | 확장을 위한 예약 비트 (일반적으로 0) |
    | **Opcode** | 4비트 | 프레임 유형 (텍스트, 바이너리, 핑, 퐁 등) |
    | **Mask** | 1비트 | 클라이언트→서버 메시지에서만 사용됨 (항상 1) |
    | **Payload Length** | 7~64비트 | 데이터 길이 |
    | **Masking Key** | 4바이트 | 클라이언트→서버 데이터 마스킹용 (필수) |
    | **Payload Data** | 가변 길이 | 실제 데이터 (텍스트/바이너리) |
- 경계
    - 하나의 완전한 메시지가 어디에서 시작하고 끝나는지 알려줌
    - FIN 비트를 이용해서 표시함
        - 1이면 해당 프레임이 마지막 프레임임을 의미
        - 0이면 추가 프레임이 이어진다는 의미로, 다음 프레임이 올 때까지 메시지 완성 x
    - Opcode값
        - 첫 번째 프레임은 0x1 또는 0x2로 시작
        - 이어지는 데이터는 0x0으로 추가됨.

---

## Close 프레임의 역할

- Close 프레임은 웹소켓에서 연결 종료를 요청하거나 확인하는 역할. Opcode 0x8

- Close 프레임 구조
    
    
    | 필드 | 크기 | 설명 |
    | --- | --- | --- |
    | **FIN** | 1비트 | 항상 `1` (프레임의 끝) |
    | **Opcode** | 4비트 | `0x8` (Close 프레임) |
    | **Payload Length** | 7~64비트 | 종료 코드 + 종료 이유 길이 |
    | **Payload Data** | 가변 길이 | 종료 코드(2바이트) + 선택적 이유 메시지 |
    
    정상 종료일 경우 Payload Data가 없음
    

- 웹소켓은 TCP와 달리 명확한 종료 핸드셰이크가 필요함. 이유는? 명확한 종료가 없으면 연결이 끊기지 않고 지속적으로 유지하게 됨.
    - 그래서 클라이언트 또는 서버가 먼저 Close 프레임을 보내면 상대방은 이를 수신하고 응답 Close 프레임을 보낸 후 연결 종료

- 종료 코드를 통해 정상 종료인지, 비정상 종료인지 이유를 알 수 있음
